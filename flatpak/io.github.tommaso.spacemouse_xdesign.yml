app-id: io.github.tommaso.spacemouse_xdesign
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
command: spacemouse-bridge
finish-args:
  # Network access for WebSocket server
  - --share=network
  # Device access for SpaceMouse (/dev/input/event*) and uinput
  - --device=all
  # Display access (for inference logic, though mostly backend)
  - --socket=wayland
  - --socket=fallback-x11
  # System bus for DBus discovery (optional but good for browser launch)
  - --socket=system-bus
  # Allow opening URLs in host browser
  - --talk-name=org.freedesktop.Portal.OpenURI

modules:
  # 1. libspnav (C Dependency)
  - name: libspnav
    buildsystem: simple
    build-commands:
      - ./configure --prefix=/app
      - make
      - make install
    sources:
      - type: archive
        url: https://github.com/FreeSpacenav/libspnav/archive/refs/tags/v1.1.tar.gz
        sha256: 04b297f68a10db4fa40edf68d7f823ba7b9d0442f2b665181889abe2cea42759

  # 2. Python Dependencies
  # (Instructions: generate this using flatpak-pip-generator)
  - python3-requirements.json

  # 3. The Bridge Application
  - name: spacemouse-bridge
    buildsystem: simple
    build-commands:
      - mkdir -p /app/bin /app/share/spacemouse-bridge
      - cp main.py spnav_wrapper.py uinput_wrapper.py /app/share/spacemouse-bridge/
      - cp -r config_ui /app/share/spacemouse-bridge/
      # Create launcher script
      - echo '#!/bin/sh' > /app/bin/spacemouse-bridge
      - echo 'cd /app/share/spacemouse-bridge' >> /app/bin/spacemouse-bridge
      - echo 'exec python3 main.py "$@"' >> /app/bin/spacemouse-bridge
      - chmod +x /app/bin/spacemouse-bridge
    sources:
      - type: dir
        path: ..
